generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int                 @id @default(autoincrement())
  username  String              @unique
  password  String
  createdAt DateTime            @default(now())
  role      UserRole            @default(USER)
  Summary   Summary[]
  topics    UserOntologyTopic[]
}

model Summary {
  id                  String        @id @default(uuid())
  youtubeUrl          String
  status              SummaryStatus @default(QUEUED)
  percent             Int           @default(0)
  startedAt           DateTime      @default(now())
  finishedAt          DateTime?
  transcriptPath      String?
  bulletPath          String?
  summaryPath         String?
  sceneFactsPath      String?
  whisperModel        String?
  asrDevice           String?
  vlDevice            String?
  vlModel             String?
  sceneThresh         Float?
  enableOcr           Boolean?
  frames              Int?
  bulletCount         Int?
  transcriptWord      Int?
  summaryWord         Int?
  timeDownloadSec     Float?
  timeSpeechtoTextSec Float?
  timeCaptionImageSec Float?
  timeSummarizeSec    Float?
  timeTotal           Float?
  durationSec         Float?
  errorMessage        String?
  keyword             String?
  userId              Int
  whisperTemp         Float?
  ChatSession         ChatSession?
  User                User          @relation(fields: [userId], references: [id])

  @@index([status, startedAt])
}

model OntologyTopic {
  id                String                  @id @default(uuid()) @db.Uuid
  name              String                  @unique
  description       String?
  createdAt         DateTime                @default(now())
  frequency         Int                     @default(0)
  score             Float?
  relatedTopics     String[]                @default([])
  outgoingRelations OntologyTopicRelation[] @relation("FromTopic")
  incomingRelations OntologyTopicRelation[] @relation("ToTopic")
  users             UserOntologyTopic[]     @relation("TopicUsers")
}

model UserOntologyTopic {
  userId    Int
  topicId   String        @db.Uuid
  createdAt DateTime      @default(now())
  topic     OntologyTopic @relation("TopicUsers", fields: [topicId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, topicId])
  @@index([userId])
  @@index([topicId])
}

model OntologyTopicRelation {
  fromTopicId String        @db.Uuid
  toTopicId   String        @db.Uuid
  weight      Float?
  fromTopic   OntologyTopic @relation("FromTopic", fields: [fromTopicId], references: [id], onDelete: Cascade)
  toTopic     OntologyTopic @relation("ToTopic", fields: [toTopicId], references: [id], onDelete: Cascade)

  @@id([fromTopicId, toTopicId])
}

model ChatMessage {
  id          Int         @id @default(autoincrement())
  sessionId   Int
  role        ChatRole
  content     String
  createdAt   DateTime    @default(now())
  ChatSession ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model ChatSession {
  id          Int           @id @default(autoincrement())
  summaryId   String        @unique
  createdAt   DateTime      @default(now())
  updatedAt   DateTime
  ChatMessage ChatMessage[]
  Summary     Summary       @relation(fields: [summaryId], references: [id], onDelete: Cascade)
}

enum SummaryStatus {
  QUEUED
  RUNNING
  DONE
  ERROR
  CANCEL
}

enum ChatRole {
  USER
  ASSISTANT
  SYSTEM
}

enum UserRole {
  ADMIN
  USER
}
